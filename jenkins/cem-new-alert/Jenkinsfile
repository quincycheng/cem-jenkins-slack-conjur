pipeline {
    agent any
    
    stages {
        stage('Get Event Type') {
            steps {
                echo "Event Type: $event_type"
            }
        }
        stage('Workspace connection error') {
            when {
                environment name: 'event_type', value: 'accountConnectionError' 
            }
            steps {
                slackSend (
                    color: "danger",
                    message: "ğŸ”¥ *" + event_payload_account_name + " on " + event_payload_platform_name + " connection error*\n"
                        + "      ğŸ¥ " + event_payload_status + "\n"
                        + "      ğŸ©º " + event_payload_status_reason + "\n"
                        + "      ğŸ’Š Visit <https://cem.cyberark.com/platforms/"+event_payload_platform_name+"|CyberArk CEM> to fix it"
                )
            }
        }
        stage('Global Exposure increased') {
            when {
                environment name: 'event_type', value: 'globalExposureLevelExceeded' 
            }
            steps {
                slackSend (
                    color: "warning",
                    message: "ğŸ†™ *Global Exposure Increased*\n"
                        + "      ğŸ”º " +  event_payload_new_exposure_level 
                        + " (was: " +  event_payload_previous_exposure_level +")\n"
                        + "      ğŸ’Š Visit <https://cem.cyberark.com/platforms/|CyberArk CEM> for more details"
                )
            }
            
        }
        stage('New shadow admin detected') {
            when {
                environment name: 'event_type', value: 'newShadowAdminDetected' 
            }
            steps {
                // TODO
                echo "TODO: New shadow admin detected"

            }
        }
        stage('New full admin detected') {
            when {
                environment name: 'event_type', value: 'newFullAdminDetected' 
            }
            steps {
                // TODO
                echo "TODO: New full admin detected"
            }
        }
        stage('Entities Exposure Level Increased') {
            when {
                environment name: 'event_type', value: 'entitiesExposureLevelIncreased' 
            }
            steps {
                script {
                    def noOfEntitles = Integer.parseInt(sh (
                            script: " echo '" + env.event_payload + "' | jq .entities | jq length ",
                            returnStdout: true
                        ).trim())
                    
                    theMsg = noOfEntitles + " entities' exposure level increased\n"

                    for (int i=0; i<noOfEntitles; i++) {
                        theMsg += "\n"
                        blocks =[[
                                    "type": "section",
                                    "text": [
                                        "type": "mrkdwn",
                                        "text": ":chart_with_upwards_trend: CEM detected "+noOfEntitles+" entities' *exposure level increased*"
                                    ]
                                ]]
                        
                        entityId    = sh (returnStdout: true, script: "echo '" + env.event_payload + "'  | jq -r .entities["+i+"].entity_id ").trim()
                        entityName  = sh (returnStdout: true, script: "echo '" + env.event_payload + "'  | jq -r .entities["+i+"].entity_name ").trim()
                        newLevel    = sh (returnStdout: true, script: "echo '" + env.event_payload + "'  | jq -r .entities["+i+"].new_exposure_level ").trim()
                        oldLevel    = sh (returnStdout: true, script: "echo '" + env.event_payload + "'  | jq -r .entities["+i+"].previous_exposure_level ").trim()
                    
                        block.add(["type": "divider"])   
                        theMsg += "*" + (i+1) + ") " + entityName + "*ğŸ”º "+ newLevel + " (was:" + oldLevel + ") "
                        //theMsg += "_Send the message below to learn more_\n"
                        //theMsg += "/cem GetRecommendations "+ env.event_payload_platform_name + " " + env.event_payload_account_id + " " + entityId + "\n"
                    }    
                    slackSend (
                        color: "warning",
                        blocks: blocks
                    )
                }
            }
        }
    }
}
